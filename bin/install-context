#!/usr/bin/env ruby
# frozen_string_literal: true

require 'fileutils'
require 'optparse'

GEM_ROOT = File.expand_path('../..', __FILE__)
TEMPLATE = File.join(GEM_ROOT, 'templates', 'agent-context.md')
DEFAULT_TARGET = 'AGENTS.md'
EXAMPLES_DIR = 'docs/rubocop-monolith-idioms-examples'
EXAMPLES_SOURCE = File.join(GEM_ROOT, 'examples')

options = { with_examples: true }
OptionParser.new do |opts|
  opts.banner = "Usage: install-context [options]"

  opts.on('--path PATH', "Target path (default: #{DEFAULT_TARGET})") do |p|
    options[:path] = p
  end

  opts.on('--force', 'Overwrite existing file') do
    options[:force] = true
  end

  opts.on('--without-examples', 'Skip copying Naming/MethodNameGetPrefix examples') do
    options[:with_examples] = false
  end

  opts.on('-h', '--help', 'Show this help') do
    puts opts
    exit
  end
end.parse!

target = options[:path] || DEFAULT_TARGET
root = Dir.pwd

if File.exist?(target) && !options[:force]
  warn "#{target} already exists. Use --force to overwrite."
  exit 0
end

FileUtils.mkdir_p(File.dirname(target))
FileUtils.cp(TEMPLATE, target)
puts "Installed agent context to #{target}"

if options[:with_examples]
  examples_dest = File.join(root, EXAMPLES_DIR)
  md_source = File.join(EXAMPLES_SOURCE, 'Naming-MethodNameGetPrefix.md')

  FileUtils.mkdir_p(examples_dest)
  FileUtils.cp(md_source, examples_dest) if File.exist?(md_source)

  puts "Installed examples to #{EXAMPLES_DIR}/"
end
